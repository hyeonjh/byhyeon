name: Deploy Changed Services Only

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - '**.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) AWS ìžê²©ì¦ëª… ì„¤ì • (Secrets.AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION í•„ìš”)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 2) ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 3) FastAPI ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push FastAPI image
        if: github.event_name == 'push' && (contains(github.event.head_commit.message, 'fastapi') || contains(join(github.event.commits.*.modified, '\n'), 'fastapi/') || contains(join(github.event.commits.*.added, '\n'), 'fastapi/'))
        uses: docker/build-push-action@v5
        with:
          context: ./fastapi
          file: ./fastapi/Dockerfile
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/byhyeon:fastapi-latest

      - name: Set up SSH
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa
          eval "$(ssh-agent -s)"
          ssh-add id_rsa
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # - name: Step 1 - Git Pull & Set KUBECONFIG & Create ECR Secret
      #   run: |
      #     ssh -i id_rsa -p 2222 -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
      #     set -e
      #     cd ~/byhyeon
      #     git pull origin main

      #     echo 'ðŸ“ KUBECONFIG ê¶Œí•œ ìœ ì§€í•˜ë©´ì„œ ~/.kube/config ì„¸íŒ…'
      #     mkdir -p ~/.kube
      #     sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
      #     sudo chown $(whoami) ~/.kube/config
      #     chmod 600 ~/.kube/config

      #     echo 'ðŸ” ECR Secret ìƒì„± - ë¬´ì¡°ê±´ ê°±ì‹ '
      #     aws ecr get-login-password --region ap-northeast-2 | \
      #     kubectl create secret docker-registry ecr-registry \
      #       --docker-server=329599615061.dkr.ecr.ap-northeast-2.amazonaws.com \
      #       --docker-username=AWS \
      #       --docker-password=$(aws ecr get-login-password) \
      #       --namespace=default \
      #       --dry-run=client -o yaml | kubectl apply -f -
      #     EOF

      - name: FastAPI + Monitoring Helm ë°°í¬
        run: |
          ssh -i id_rsa -p 2222 -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << EOF
          set -e
          cd ~/byhyeon

          echo 'ðŸ“¥ Git Pull'
          git pull origin main

          CHANGED_FILES=$(git diff --name-only HEAD@{1} HEAD)

          echo "ðŸ” ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
          if [ -n "\$CHANGED_FILES" ]; then
            printf "%s\n" "\$CHANGED_FILES"
          else
            echo "(no changed files)"
          fi

          # FastAPI ë³€ê²½ ê°ì§€
          if echo "\$CHANGED_FILES" | grep -qE '(^|/)(helm/fastapi-chart/|fastapi/)'; then
            echo 'ðŸš€ FastAPI Helm ì°¨íŠ¸ ë³€ê²½ ê°ì§€ â†’ helm upgrade ì‹¤í–‰'
            helm upgrade --install fastapi ./helm/fastapi-chart -n fastapi --create-namespace -f ./helm/fastapi-chart/values.yaml --create-namespace
            echo 'ðŸ”„ FastAPI Deployment rollout ê°•ì œ ìž¬ì‹œìž‘'
            kubectl rollout restart deployment fastapi -n fastapi
            echo 'âœ… FastAPI ìž¬ë°°í¬ ì™„ë£Œ'
          else
            echo 'â„¹ï¸ FastAPI ê´€ë ¨ ë³€ê²½ì‚¬í•­ ì—†ìŒ'
          fi

          # Monitoring (Prometheus) ë³€ê²½ ê°ì§€
          if echo "\$CHANGED_FILES" | grep -qE '(^|/)helm/monitoring/prometheus/'; then
            echo 'ðŸš€ Prometheus Helm ì°¨íŠ¸ ë³€ê²½ ê°ì§€ â†’ helm upgrade ì‹¤í–‰'
            helm upgrade --install prometheus ./helm/monitoring/prometheus -n monitoring --create-namespace -f ./helm/monitoring/prometheus/values.yaml
          else
            echo 'â„¹ï¸ Prometheus ê´€ë ¨ ë³€ê²½ì‚¬í•­ ì—†ìŒ'
          fi

          # Monitoring (Grafana) ë³€ê²½ ê°ì§€
          if echo "\$CHANGED_FILES" | grep -qE '(^|/)helm/monitoring/grafana/'; then
            echo 'ðŸš€ Grafana Helm ì°¨íŠ¸ ë³€ê²½ ê°ì§€ â†’ helm upgrade ì‹¤í–‰'
            helm upgrade --install grafana ./helm/monitoring/grafana -n monitoring --create-namespace -f ./helm/monitoring/grafana/values.yaml
          else
            echo 'â„¹ï¸ Grafana ê´€ë ¨ ë³€ê²½ì‚¬í•­ ì—†ìŒ'
          fi

          EOF

#####################ë³€ê²½ì „ deploy 
      # - name: Deploy changed services
      #   run: |
      #     chmod 600 id_rsa
      #     ssh -i id_rsa -p 2222 -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << EOF
      #     set -e
      #     mkdir -p ~/byhyeon && cd ~/byhyeon
      #     git pull origin main

      #     echo 'ðŸ” ECR Secret ë¬´ì¡°ê±´ ê°±ì‹ '
      #     aws ecr get-login-password --region ap-northeast-2 | \
      #     kubectl create secret docker-registry ecr-registry \
      #       --docker-server=329599615061.dkr.ecr.ap-northeast-2.amazonaws.com \
      #       --docker-username=AWS \
      #       --docker-password=$(aws ecr get-login-password) \
      #       --namespace=default \
      #       --dry-run=client -o yaml | kubectl apply -f -

      #     # ì•ˆì „í•˜ê²Œ í˜„ìž¬ ì»¤ë°‹ ê¸°ì¤€ìœ¼ë¡œë§Œ ë³€ê²½ëœ íŒŒì¼ í™•ì¸
      #     CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

      #     echo "ðŸ”„ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
      #     echo "$CHANGED_FILES" | sed '/^$/d' | sed 's/^/ðŸ“ /'

      #     if echo "$CHANGED_FILES" | grep -qE '^helm/fastapi-chart/|^fastapi/'; then
      #       echo 'ðŸš€ FastAPI Helm ì°¨íŠ¸ ë³€ê²½ ê°ì§€ â†’ helm upgrade ì‹¤í–‰'
      #       helm upgrade --install fastapi ./helm/fastapi-chart -n default
      #     fi

      #     if echo "\$CHANGED_FILES" | grep -qE '^airflow/|docker-compose-airflow.yaml'; then
      #       echo 'â–¶ï¸ Airflow ë³€ê²½ ê°ì§€ â†’ ìž¬ë¹Œë“œ ë° ìž¬ì‹œìž‘'
      #       docker compose -f docker-compose-airflow.yaml up --build --force-recreate -d airflow-webserver airflow-scheduler
      #     fi

      #     if echo "\$CHANGED_FILES" | grep -qE '^monitoring/|docker-compose-monitoring.yaml'; then
      #       echo 'â–¶ï¸ Monitoring ë³€ê²½ ê°ì§€ â†’ ìž¬ë¹Œë“œ ë° ìž¬ì‹œìž‘'
      #       docker compose -f docker-compose-monitoring.yaml up --build --force-recreate -d grafana prometheus cadvisor
      #     fi
          
      #     if echo "$CHANGED_FILES" | grep -qE '^filebeat/|^docker-compose-elk.yaml$'; then
      #       echo 'ðŸ“¦ ELK ë³€ê²½ ê°ì§€ â†’ ìž¬ì‹œìž‘'
      #       docker compose -f docker-compose-elk.yaml up --force-recreate -d elasticsearch kibana filebeat
      #     fi
      #     EOF
      #   env:
      #     PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #     SSH_USER: ${{ secrets.SSH_USER }}
      #     SERVER_IP: ${{ secrets.SERVER_IP }}

      - name: Cleanup SSH Key
        run: rm -f id_rsa
