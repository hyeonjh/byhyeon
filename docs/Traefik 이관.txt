#######################################################
# NGINX ì¢…ë£Œ í›„ Traefikìœ¼ë¡œ íŠ¸ë˜í”½ í¬íŠ¸ ì´ê´€
#######################################################

1. NGINX ì¢…ë£Œ ë° ë¹„í™œì„±í™” (80/443 í¬íŠ¸ í™•ë³´)
--------------------------------------------------
sudo systemctl stop nginx
sudo systemctl disable nginx


2. Traefik ë™ì‘ í™•ì¸
--------------------------------------------------
kubectl get pods -n kube-system | grep traefik


3. cert-manager ì„¤ì¹˜ ë° ClusterIssuer ì„¸íŒ…
--------------------------------------------------
# cert-manager ì„¤ì¹˜ (Letâ€™s Encrypt ìë™ ë°œê¸‰ìš©)
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.yaml

# ClusterIssuer ìƒì„±
kubectl apply -f clusterissuer.yaml


4. AWS CLI ë° ECR ì—°ë™
--------------------------------------------------
# AWS CLI ì„¤ì¹˜
pip3 install awscli --user --break-system-packages

# PATH ë“±ë¡
echo 'export PATH=$PATH:$HOME/.local/bin' >> ~/.bashrc
source ~/.bashrc

# ì„¤ì¹˜ í™•ì¸
aws --version

# ECR ì‹œí¬ë¦¿ ìƒì„±
aws ecr get-login-password --region ap-northeast-2 | \
kubectl create secret docker-registry ecr-registry \
--docker-server=329599615061.dkr.ecr.ap-northeast-2.amazonaws.com \
--docker-username=AWS \
--docker-password=$(aws ecr get-login-password --region ap-northeast-2) \
--docker-email=example@test.com


5. ì„œë¹„ìŠ¤ íƒ€ì…ì„ NodePortë¡œ ë³€ê²½ í›„ ë°©í™”ë²½ ì—´ê¸°
--------------------------------------------------
# fastapi-service.yaml ì ìš©
kubectl apply -f k8s/fastapi/fastapi-service.yaml

# ë°©í™”ë²½ì—ì„œ nodeport í—ˆìš© (ì˜ˆ: 30080)
sudo ufw allow 30080/tcp


6. NGINX ëŒ€ì²´ í”„ë¡ì‹œ ì„¤ì • ì‹œ ì°¸ê³ 
--------------------------------------------------
# ì˜ˆì‹œ ì„¤ì • (ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²½ìš° ìƒëµ ê°€ëŠ¥)
location / {
  proxy_pass http://127.0.0.1:30080/;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
}


# ğŸ”§ NGINX ì¢…ë£Œ í›„ Traefik í¬íŠ¸ í™•ë³´
sudo systemctl stop nginx
sudo systemctl disable nginx

# ğŸ§­ Traefik ë™ì‘ í™•ì¸
kubectl get pods -n kube-system | grep traefik

# ğŸ” cert-manager ì„¤ì¹˜ (Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰ìš©)
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.yaml

# ğŸ” ClusterIssuer ìƒì„±
kubectl apply -f clusterissuer.yaml

# âš™ï¸ AWS CLI ì„¤ì¹˜ ë° ì„¤ì •
pip3 install awscli --user --break-system-packages
echo 'export PATH=$PATH:$HOME/.local/bin' >> ~/.bashrc
source ~/.bashrc
aws configure  # Access Key, Secret, Region ì„¤ì •

# ğŸ”‘ ECRìš© imagePullSecret ìƒì„±
aws ecr get-login-password --region ap-northeast-2 | \
kubectl create secret docker-registry ecr-registry \
--docker-server=329599615061.dkr.ecr.ap-northeast-2.amazonaws.com \
--docker-username=AWS \
--docker-password=$(aws ecr get-login-password --region ap-northeast-2) \
--docker-email=example@test.com

# ğŸ“¦ FastAPI ë°°í¬ ë¦¬ì†ŒìŠ¤ ì ìš©
kubectl apply -f fastapi-deployment.yaml
kubectl apply -f fastapi-service.yaml
kubectl apply -f fastapi-ingress.yaml

# ğŸ” TLS ì¸ì¦ì„œ ìƒíƒœ í™•ì¸
kubectl get certificate
kubectl describe certificate fastapi-tls

# ğŸ” ë¬¸ì œê°€ ìˆìœ¼ë©´ ì‚­ì œ í›„ ì¬ìƒì„±
kubectl delete certificate fastapi-tls
kubectl apply -f fastapi-ingress.yaml